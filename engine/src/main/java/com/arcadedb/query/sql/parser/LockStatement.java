/* Generated By:JJTree: Do not edit this line. LockStatement.java Version 7.0 */
/* JavaCCOptions:MULTI=true,NODE_USES_PARSER=false,VISITOR=false,TRACK_TOKENS=true,NODE_PREFIX=,NODE_EXTENDS=,NODE_FACTORY=,SUPPORT_CLASS_VISIBILITY_PUBLIC=true */
package com.arcadedb.query.sql.parser;

import com.arcadedb.database.DatabaseInternal;
import com.arcadedb.database.TransactionExplicitLock;
import com.arcadedb.query.sql.executor.CommandContext;
import com.arcadedb.query.sql.executor.InternalResultSet;
import com.arcadedb.query.sql.executor.ResultInternal;
import com.arcadedb.query.sql.executor.ResultSet;

import java.util.*;

public class LockStatement extends SimpleExecStatement {
  protected List<Identifier> lockTypeNames;
  protected List<Identifier> lockBucketNames;

  public LockStatement(final int id) {
    super(id);
  }

  @Override
  public ResultSet executeSimple(final CommandContext context) {
    final DatabaseInternal database = context.getDatabase();

    TransactionExplicitLock explicitLock = null;
    if (lockTypeNames != null && !lockTypeNames.isEmpty()) {
      explicitLock = context.getDatabase().acquireLock();

      for (Identifier typeName : lockTypeNames)
        explicitLock.type(typeName.getStringValue());
    }

    if (lockBucketNames != null && !lockBucketNames.isEmpty()) {
      if (explicitLock == null)
        explicitLock = context.getDatabase().acquireLock();

      for (Identifier bucketName : lockBucketNames)
        explicitLock.bucket(bucketName.getStringValue());
    }

    if (explicitLock != null)
      explicitLock.lock();

    final InternalResultSet result = new InternalResultSet();
    final ResultInternal item = new ResultInternal(database);
    item.setProperty("operation", "lock");
    result.add(item);
    return result;
  }

  @Override
  public void toString(final Map<String, Object> params, final StringBuilder builder) {
    builder.append("LOCK");
    if (lockTypeNames != null && !lockTypeNames.isEmpty())
      builder.append(" TYPE ").append(String.join(", ", lockTypeNames.stream().map(Identifier::getStringValue).toList()));
    if (lockBucketNames != null && !lockBucketNames.isEmpty())
      builder.append(" BUCKET ").append(String.join(", ", lockBucketNames.stream().map(Identifier::getStringValue).toList()));

  }

  @Override
  public LockStatement copy() {
    final LockStatement result = new LockStatement(-1);
    result.lockTypeNames = lockTypeNames == null ? null : new ArrayList<>(lockTypeNames);
    result.lockBucketNames = lockBucketNames == null ? null : new ArrayList<>(lockBucketNames);
    return result;
  }

  @Override
  protected Object[] getIdentityElements() {
    return new Object[] { lockTypeNames, lockBucketNames };
  }
}
/* JavaCC - OriginalChecksum=1f7d8e694c5a2e60168dc050e867c9cb (do not edit this line) */
