package com.arcadedb;

import com.arcadedb.database.Database;
import com.arcadedb.database.DatabaseFactory;
import com.arcadedb.query.sql.parser.MatchStatement;
import com.arcadedb.query.sql.parser.StatementCache;

import java.util.List;
import java.util.Map;

/**
 * Compares the AST generated by ANTLR and JavaCC parsers for the same MATCH query.
 */
public class CompareParserAST {
  public static void main(String[] args) {
    DatabaseFactory factory = new DatabaseFactory("./target/databases/compare-parser");
    if (factory.exists()) {
      factory.open().drop();
    }
    Database database = factory.create();

    try {
      String query = """
          MATCH {type:Employee, where: (name = 'p10')}\
          .out('WorksAt')\
          .out('ParentDepartment'){\
              while: (in('ManagerOf').size() == 0),\
              where: (in('ManagerOf').size() > 0)\
          }\
          .in('ManagerOf'){as: manager}\
          RETURN manager""";

      System.out.println("=== ANTLR Parser AST ===");
      GlobalConfiguration.SQL_PARSER_IMPLEMENTATION.setValue("antlr");
      StatementCache cacheAntlr = new StatementCache(database, 0);
      MatchStatement stmtAntlr = (MatchStatement) cacheAntlr.get(query);
      Map<String, Object> jsonAntlr = stmtAntlr.toJSON();
      printJSON(jsonAntlr, 0);

      System.out.println("\n\n=== JavaCC Parser AST ===");
      GlobalConfiguration.SQL_PARSER_IMPLEMENTATION.setValue("javacc");
      StatementCache cacheJavaCC = new StatementCache(database, 0);
      MatchStatement stmtJavaCC = (MatchStatement) cacheJavaCC.get(query);
      Map<String, Object> jsonJavaCC = stmtJavaCC.toJSON();
      printJSON(jsonJavaCC, 0);

      System.out.println("\n\n=== Comparison ===");
      System.out.println("ASTs are equal: " + jsonAntlr.equals(jsonJavaCC));

    } finally {
      database.drop();
    }
  }

  private static void printJSON(Object obj, int indent) {
    String indentStr = "  ".repeat(indent);
    if (obj instanceof Map) {
      Map<?, ?> map = (Map<?, ?>) obj;
      for (Map.Entry<?, ?> entry : map.entrySet()) {
        if (entry.getValue() instanceof Map) {
          System.out.println(indentStr + entry.getKey() + ":");
          printJSON(entry.getValue(), indent + 1);
        } else if (entry.getValue() instanceof List) {
          System.out.println(indentStr + entry.getKey() + ":");
          int i = 0;
          for (Object item : (List<?>) entry.getValue()) {
            System.out.println(indentStr + "  [" + i++ + "]:");
            printJSON(item, indent + 2);
          }
        } else {
          System.out.println(indentStr + entry.getKey() + ": " + entry.getValue());
        }
      }
    } else {
      System.out.println(indentStr + obj);
    }
  }
}
