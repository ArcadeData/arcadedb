<div class="tab-pane fade show active" id="tab-query" role="tabpanel">
  <div class="d-flex align-items-center flex-shrink-0" style="padding: 10px 12px 6px;" id="queryPanel">
    <div class="d-flex align-items-center gap-2">
      <i class="fa fa-terminal" style="font-size: 1.2rem; color: #00aeee;"></i>
      <label>Connected as&nbsp;</label><label for="queryInputDatabase" id="queryUser"></label>@
      <select id="queryInputDatabase" class="inputDatabase form-select form-select-sm" style="width: auto; display: inline-block;"></select>
    </div>
  </div>

  <div class="d-flex" style="flex: 1; min-height: 0;">
    <!-- Icon Sidebar -->
    <div id="queryIconSidebar">
      <button class="icon-sidebar-btn active" data-panel="overview" onclick="switchSidebarPanel('overview')" title="Database Overview">
        <i class="fa fa-database"></i>
      </button>
      <button class="icon-sidebar-btn" data-panel="history" onclick="switchSidebarPanel('history')" title="History">
        <i class="fa fa-clock"></i>
      </button>
      <button class="icon-sidebar-btn" data-panel="saved" onclick="switchSidebarPanel('saved')" title="Saved Queries">
        <i class="fa fa-bookmark"></i>
      </button>
      <button class="icon-sidebar-btn" data-panel="reference" onclick="switchSidebarPanel('reference')" title="Reference">
        <i class="fa fa-book"></i>
      </button>
      <button class="icon-sidebar-btn" data-panel="settings" onclick="switchSidebarPanel('settings')" title="Settings">
        <i class="fa fa-gear"></i>
      </button>
    </div>

    <!-- Database Information Sidebar -->
    <div id="querySidebar">
      <div class="sidebar-header">
        <span class="sidebar-title" id="sidebarPanelTitle">Database Info</span>
        <button class="btn btn-sm btn-light sidebar-refresh-btn" id="sidebarRefreshBtn" onclick="refreshQuerySidebar()" title="Refresh">
          <i class="fa fa-sync"></i>
        </button>
      </div>
      <div id="querySidebarContent">
        <!-- Overview Panel -->
        <div class="sidebar-panel active" id="sidebarPanelOverview">
          <div class="sidebar-empty">Loading...</div>
        </div>
        <!-- History Panel -->
        <div class="sidebar-panel" id="sidebarPanelHistory"></div>
        <!-- Saved Queries Panel -->
        <div class="sidebar-panel" id="sidebarPanelSaved"></div>
        <!-- Reference Panel -->
        <div class="sidebar-panel" id="sidebarPanelReference"></div>
        <!-- Settings Panel -->
        <div class="sidebar-panel" id="sidebarPanelSettings"></div>
      </div>
    </div>

    <!-- Query Work Area -->
    <div id="queryWorkArea" style="flex: 1; min-width: 0; overflow-y: auto; overflow-x: hidden; padding-left: 12px; padding-right: 12px;">

      <div class="row mb-2">
        <div class="col-4">
          <select id="inputLanguage" class="form-select" style="color: var(--color-brand)">
            <option value="sql" selected>SQL</option>
            <option value="sqlScript">SQL Script</option>
            <option value="opencypher">Open Cypher (New Native Engine)</option>
            <option value="gremlin">Gremlin</option>
            <option value="cypher">Cypher (Old Engine)</option>
            <option value="graphql">GraphQL</option>
            <option value="mongo">MongoDB</option>
            <option value="redis">Redis</option>
          </select>
        </div>
        <div class="col-8">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <label
                >Auto Limit
                <i
                  class="fa fa-question-circle"
                  data-toggle="tooltip"
                  data-html="true"
                  title="If the limit is not set in the query, then the following automatic limit is used."
                ></i>
                <select id="inputLimit">
                  <option value="20">20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="500">500</option>
                  <option value="-1">No Limits</option>
                </select>
              </label>
            </div>
            <div class="result-stats">
              <label>Returned <span id="result-num" class="result-stat-value"></span>&nbsp;records in <span id="result-elapsed" class="result-stat-value"></span>&nbsp;ms</label>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="query-editor-container">
            <div class="query-editor-area">
              <textarea id="inputCommand" name="inputCommand"></textarea>
            </div>
            <div class="query-editor-actions">
              <button class="editor-action-btn editor-save-btn" onclick="saveCurrentQuery()" title="Save query">
                <i class="fa fa-bookmark"></i>
              </button>
              <div class="editor-action-divider"></div>
              <button class="editor-action-btn editor-run-btn" data-testid="execute-query-button" onclick="resetHistoryNavigation(); executeCommand()" title="Run (Ctrl+Enter)">
                <i class="fa fa-play"></i>
                <img id="executeSpinner" class="ui-loading" src="images/color-spin-small.svg" style="display: none" />
              </button>
            </div>
          </div>
        </div>

        <div class="col-12">
          <ul class="nav nav-tabs" id="tabs-command">
            <li class="nav-item">
              <a data-toggle="tab" href="#tab-table" class="active show nav-link" id="tab-table-sel">
                <center><i class="fa fa-table"></i> <span class="mini-text">Table</span></center>
              </a>
            </li>
            <li class="nav-item">
              <a data-toggle="tab" href="#tab-graph" class="nav-link" id="tab-graph-sel">
                <center><i class="fa fa-project-diagram"></i> <span class="mini-text">Graph</span></center>
              </a>
            </li>
            <li class="nav-item">
              <a data-toggle="tab" href="#tab-json" class="nav-link" id="tab-json-sel">
                <center><i class="fa fa-file-code"></i> <span class="mini-text">Json</span></center>
              </a>
            </li>
            <li class="nav-item">
              <a data-toggle="tab" href="#tab-explain" class="nav-link" id="tab-explain-sel">
                <center><i class="fa fa-list"></i> <span class="mini-text">Explain</span></center>
              </a>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-table" role="tabpanel">
              <div class="table-responsive">
                <table id="result" class="table table-striped table-sm" style="width: 100%; table-layout: fixed"></table>
              </div>
              <div id="tableRecordEditorOverlay" class="record-editor-overlay">
                <div id="tableRecordEditorContent"></div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-graph" role="tabpanel">
              <div class="row">
                <div class="col-12">
                  <nav class="navbar navbar-expand-lg navbar-light">
                    <button
                      class="navbar-toggler"
                      type="button"
                      data-toggle="collapse"
                      data-target="#navbarSupportedContent"
                      aria-controls="navbarSupportedContent"
                      aria-expanded="false"
                      aria-label="Toggle navigation"
                    >
                      <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                      <div class="d-flex my-2 my-lg-0">
                        <input id="inputGraphSearch" class="form-control me-sm-2" type="search" placeholder="Search" aria-label="Search" autocomplete="off" />
                        <button class="btn btn-secondary" onclick="searchInGraph()" href="#"><i class="fa fa-search"></i></button>
                      </div>
                      <ul class="navbar-nav me-auto">
                        <li class="nav-item"></li>
                      </ul>
                      <ul class="navbar-nav">
                        <li class="nav-item">
                          <a class="nav-link btn btn-secondary" href="#" onclick="renderGraph()"><i class="fa fa-sync"></i> Redraw</a>
                        </li>
                        <li class="nav-item dropdown">
                          <a
                            class="nav-link dropdown-toggle btn btn-secondary"
                            href="#"
                            role="button"
                            aria-haspopup="true"
                            aria-expanded="false"
                            class="dropdown-toggle"
                            data-toggle="dropdown"
                          >
                            <i class="fa fa-hand-pointer"></i> Select
                          </a>
                          <ul class="dropdown-menu" aria-labelledby="navbarDropdown" style="width: 300px">
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="selectNeighbors(1)" disabled>Direct Neighbors</a>
                            </li>
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="selectOrphanVertices()" disabled>Orphan Vertices</a>
                            </li>
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="invertVertexSelection()" disabled>Invert Node Selection</a>
                            </li>
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="shortestPath()" disabled>Shortest Path</a>
                            </li>
                          </ul>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link btn btn-secondary" href="#" onclick="cutSelection()"><i class="fa fa-cut"></i> Cut</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link btn btn-secondary" href="#" onclick="cropSelection()"><i class="fa fa-crop"></i> Crop</a>
                        </li>
                        <li class="nav-item dropdown">
                          <a
                            class="nav-link dropdown-toggle btn btn-secondary"
                            href="#"
                            role="button"
                            aria-haspopup="true"
                            aria-expanded="false"
                            class="dropdown-toggle"
                            data-toggle="dropdown"
                          >
                            <i class="fa fa-upload"></i> Import
                          </a>
                          <ul class="dropdown-menu" aria-labelledby="navbarDropdown" style="width: 300px">
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="importGraph('json')">JSON</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" disabled>GraphML</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="importSettings()">Settings</a>
                            </li>
                          </ul>
                        </li>
                        <li class="nav-item dropdown">
                          <a
                            class="nav-link dropdown-toggle btn btn-secondary"
                            href="#"
                            role="button"
                            aria-haspopup="true"
                            aria-expanded="false"
                            class="dropdown-toggle"
                            data-toggle="dropdown"
                          >
                            <i class="fa fa-download"></i> Export
                          </a>
                          <ul class="dropdown-menu" aria-labelledby="navbarDropdown" style="width: 300px">
                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="exportGraph('json')">JSON</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="exportGraph('graphml')">GraphML</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="exportGraph('png')">PNG image</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="exportGraph('jpeg')">JPEG image</a>
                            </li>

                            <li class="dropdown-item">
                              <a class="nav-link" href="#" onclick="exportSettings()">Settings</a>
                            </li>
                          </ul>
                        </li>
                        <li class="nav-item">
                          <button
                            type="button"
                            class="btn"
                            data-toggle="tooltip"
                            data-placement="top"
                            data-html="true"
                            title="1) Hold MOUSE CLICK for context menu<br>2) CMD + MOUSE for block selection"
                          >
                            <i class="fa fa-question-circle"></i>
                          </button>
                        </li>
                      </ul>
                    </div>
                  </nav>
                </div>
              </div>

              <div class="row" style="overflow-x: hidden">
                <div class="col-12" id="graphMainPanel">
                  <div id="graph" style="height: 800px; width: 100%"></div>
                </div>
              </div>
              <div id="graphRecordEditorOverlay" class="record-editor-overlay">
                <div id="graphRecordEditorContent"></div>
              </div>

              <div class="row">
                <div class="col-12" id="graphStatus" style="height: 25px">
                  <span>&nbsp;</span>
                </div>
              </div>
            </div>

            <div class="tab-pane fade" id="tab-json" role="tabpanel">
              <ul class="navbar-nav">
                <li class="nav-item">
                  <a id="jsonToClipboard" type="button" data-clipboard-target="#resultJson" class="clipboard-trigger nav-link btn btn-secondary">
                    <i class="fa fa-copy"></i> Copy to clipboard
                  </a>
                </li>
              </ul>
              <textarea id="resultJson" style="width: 100%; height: 600px" readonly></textarea>
            </div>

            <div class="tab-pane fade" id="tab-explain" role="tabpanel">
              <nav class="navbar navbar-expand-lg navbar-light">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <div class="form-check">
                      <input id="profileCommand" class="form-check-input" type="checkbox" />
                      <label for="profileCommand" class="form-check-label">Profile Execution</label>
                      <i
                        class="fa fa-question-circle"
                        data-toggle="tooltip"
                        data-html="true"
                        title="If enabled, the command is profiled (only SQL, Gremlin and OpenCypher apply) and statistics are returned. Executing a command with profiling is more expensive, use it only when needed."
                      ></i>
                    </div>
                  </li>
                </ul>
              </nav>
              <div id="flameGraphContainer"></div>
              <textarea id="resultExplain" style="width: 100%; height: 400px; font-family: courier" readonly></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize Bootstrap 5 tooltips
  document.querySelectorAll('[data-toggle="tooltip"]').forEach(function(el) {
    new bootstrap.Tooltip(el);
  });

  var editor = null;
  var historyNavIndex = -1;
  var historyNavBuffer = "";

  function getFilteredHistory() {
    let queryHistory = getQueryHistory();
    let database = escapeHtml(getCurrentDatabase());
    let filtered = [];
    for (let i = 0; i < queryHistory.length; i++) {
      let q = queryHistory[i];
      if (q != null && q.d == database && q.l != null && q.c != null)
        filtered.push(q);
    }
    return filtered;
  }

  function historyPrevious() {
    let filtered = getFilteredHistory();
    if (filtered.length == 0) return;

    // Save current input when starting navigation
    if (historyNavIndex == -1)
      historyNavBuffer = editor.getValue();
    if (historyNavIndex < filtered.length - 1) {
      historyNavIndex++;
      let q = filtered[historyNavIndex];
      $("#inputLanguage").val(q.l);
      editor.setOption("mode", getEditorMode());
      editor.setValue(q.c);
      editor.setCursor(editor.lineCount(), 0);
    }
  }

  function historyNext() {
    if (historyNavIndex == -1) return;
    let filtered = getFilteredHistory();
    if (historyNavIndex > 0) {
      historyNavIndex--;
      let q = filtered[historyNavIndex];
      $("#inputLanguage").val(q.l);
      editor.setOption("mode", getEditorMode());
      editor.setValue(q.c);
      editor.setCursor(editor.lineCount(), 0);
    } else {
      historyNavIndex = -1;
      editor.setValue(historyNavBuffer);
      editor.setCursor(editor.lineCount(), 0);
    }
  }

  function resetHistoryNavigation() {
    historyNavIndex = -1;
    historyNavBuffer = "";
  }

  function initQuery() {
    document.querySelectorAll('[data-toggle="tooltip"]').forEach(function(el) {
      new bootstrap.Tooltip(el);
    });

    $('a[data-toggle="tab"]').on("shown.bs.tab", function (e) {
      let activeTab = $("#tabs-command .active").attr("id");
      if (activeTab == "tab-table-sel") renderTable();
      else if (activeTab == "tab-graph-sel" && globalCy == null) renderGraph();
    });

    $("#inputLanguage").change(function () {
      editor.setOption("mode", getEditorMode());
    });

    $(".dropdown-menu").on("click.bs.dropdown", function (e) {
      e.stopPropagation();
      e.preventDefault();
    });

    $("#jsonToClipboard").off("click").on("click", async function(e) {
      e.preventDefault();
      const text = $("#resultJson").val() || $("#resultJson").text();
      try {
        await navigator.clipboard.writeText(text);
        globalNotify("Content", "successfully copied in the clipboard", "success");
      } catch (err) {
        globalNotify("Error", "Failed to copy to clipboard", "danger");
      }
    });

    renderCodeEditor();
    loadFunctionReference();
    initSidebarPanels();
    populateQuerySidebar();
    executeCommand();

    var dbPar = getURLParameter("db");
    if (dbPar != null && dbPar != "null") setCurrentDatabase(dbPar);

    var limitPar = getURLParameter("limit");
    if (limitPar != null && limitPar != "null") {
      if (limitPar != "20" && limitPar != "100" && limitPar != "500" && limitPar != "-1") {
        var sanitizedLimitPar = escapeHtml(limitPar);
        $("#inputLimit").append("<option value='" + sanitizedLimitPar + "' selected='selected'>" + sanitizedLimitPar + "</option>");
      }
      $("#inputLimit").val(escapeHtml(limitPar));
    }

    $(".inputDatabase").change(function () {
      setCurrentDatabase(this.value);
      resetHistoryNavigation();
      displaySchema();
      displayDatabaseSettings();
      // Refresh active sidebar panel on database change
      refreshActiveSidebarPanel();
      // Reload timeseries types if on that tab
      if (typeof tsLoadTypes === "function")
        tsLoadTypes();
    });
  }

  function renderCodeEditor() {
    editor = CodeMirror.fromTextArea(document.getElementById("inputCommand"), {
      mode: getEditorMode(),
      lineWrapping: true,
      indentWithTabs: false,
      smartIndent: true,
      lineNumbers: true,
      matchBrackets: true,
      autofocus: true,
      viewportMargin: Infinity,
      theme: "neo",
    });

    editor.addKeyMap({
      "Ctrl-Enter": function (cm) {
        resetHistoryNavigation();
        executeCommand();
      },
      "Cmd-Enter": function (cm) {
        resetHistoryNavigation();
        executeCommand();
      },
      "Ctrl-Up": function (cm) { historyPrevious(); },
      "Ctrl-Down": function (cm) { historyNext(); },
      "Cmd-Up": function (cm) { historyPrevious(); },
      "Cmd-Down": function (cm) { historyNext(); },
      "Alt-/": function (cm) {
        CodeMirror.showHint(cm, arcadedbHint, { completeSingle: false });
      },
      "Ctrl-Space": function (cm) {
        CodeMirror.showHint(cm, arcadedbHint, { completeSingle: false });
      }
    });

    editor.on("inputRead", function (cm, event) {
      if (event.origin !== "+input")
        return;
      var cur = cm.getCursor();
      var line = cm.getLine(cur.line);
      var end = cur.ch;
      var start = end;
      while (start > 0 && /[\w._]/.test(line.charAt(start - 1)))
        start--;
      if (end - start >= 2)
        CodeMirror.showHint(cm, arcadedbHint, { completeSingle: false });
    });

    setTimeout(function () { editor.refresh(); }, 1);
  }

  function getEditorMode() {
    let language = $("#inputLanguage").val();
    let mime = null;
    if (language == "sql") mime = "arcadedb-sql";
    else if (language == "sqlScript") mime = "arcadedb-sql";
    else if (language == "cypher") mime = "application/x-cypher-query";
    else if (language == "opencypher") mime = "application/x-cypher-query";
    else if (language == "gremlin") mime = "sql";
    else if (language == "mongodb") mime = "application/json";
    else if (language == "graphql") mime = "application/json";
    else if (language == "redis") mime = "text/plain";
    return mime;
  }
</script>
