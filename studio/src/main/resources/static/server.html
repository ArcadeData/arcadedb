<div class="tab-pane fade" id="tab-server" role="tabpanel">
  <div class="d-flex align-items-center px-3 py-2" style="border-bottom: 1px solid var(--border-light);">
    <div class="flex-grow-1 d-flex align-items-center gap-3">
      <span id="serverConnectionCompact" style="font-size: 0.88rem; color: var(--text-secondary); cursor: pointer; position: relative;" onclick="toggleServerInfoPopover()">
        <i class="fa fa-server" style="color: var(--color-brand); margin-right: 6px;"></i>
        <span id="serverConnectionLabel"></span>
        <i class="fa fa-chevron-down" style="font-size: 0.6rem; margin-left: 4px; color: var(--text-lightest);"></i>
        <!-- Popover for full details -->
        <div id="serverInfoPopover" style="display:none; position:absolute; top:100%; left:0; z-index:10000; min-width:400px; background:var(--bg-card); border:1px solid var(--border-ddd); border-radius:8px; box-shadow:0 4px 16px var(--shadow-dropdown); padding:14px 18px; margin-top:4px; font-size:0.82rem; color:var(--text-secondary);">
          <div id="serverInfoPopoverBody"></div>
        </div>
      </span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm" style="color:red;" onclick="shutdownServer()" title="Shutdown Server"><i class="fas fa-power-off"></i></button>
    </div>
  </div>

  <div class="d-flex align-items-center px-2 py-1">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm db-action-btn" onclick="refreshCurrentServerTab()"><i class="fa fa-sync"></i> Refresh</button>
    </div>
    <div class="flex-grow-1">
      <ul class="nav nav-tabs text-center" id="tabs-database" style="float: right">
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-summary" class="active show nav-link" id="tab-summary-sel">Summary</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-metrics" class="nav-link" id="tab-metrics-sel">Metrics</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-sessions" class="nav-link" id="tab-server-sessions-sel">Sessions</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-events" class="nav-link" id="tab-server-events-sel">Events</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-settings" class="nav-link" id="tab-server-settings-sel">Server Settings</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-backup" class="nav-link" id="tab-server-backup-sel">Backup</a></li>
        <li class="nav-item"><a data-toggle="tab" href="#tab-server-mcp" class="nav-link" id="tab-server-mcp-sel">MCP</a></li>
      </ul>
    </div>
  </div>

  <br />

  <div class="tab-content px-2">
    <div class="tab-pane fade show active" id="tab-server-summary" role="tabpanel">
      <div id="serverSummaryLoading" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;"></div>
        <div class="text-muted small mt-2">Loading server metrics...</div>
      </div>
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center">
          <label style="font-size: 0.82rem; color: var(--text-muted); margin-right: 6px;">Auto Refresh</label>
          <select id="serverRefreshTimeout" class="form-select form-select-sm" style="width: auto;" onchange="startServerRefreshTimer(true)">
            <option value="0">Off</option>
            <option value="10">Every 10 sec</option>
            <option value="30">Every 30 sec</option>
            <option value="60">Every 1 min</option>
            <option value="300">Every 5 min</option>
          </select>
        </div>
        <div class="d-flex align-items-center gap-3" style="font-size: 0.85rem; cursor: pointer;" onclick="globalActivateTab('tab-server-events')">
          <span><span style="color: red; font-weight: 600;" id="summErrors">0</span> <span class="text-muted">Errors</span></span>
          <span><span style="color: orange; font-weight: 600;" id="summWarnings">0</span> <span class="text-muted">Warnings</span></span>
          <span><span style="color: #0d6efd; font-weight: 600;" id="summInfo">0</span> <span class="text-muted">Info</span></span>
          <span><span style="font-weight: 600;" id="summHints">0</span> <span class="text-muted">Hints</span></span>
        </div>
      </div>

      <!-- System Resources -->
      <div class="row mb-3">
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">CPU</div>
            <div class="card-body text-center">
              <div class="fs-2" id="summCpu">-</div>
              <div class="text-muted small">Load</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">RAM</div>
            <div class="card-body text-center">
              <div class="fs-4" id="summHeapUsed">-</div>
              <div class="text-muted small">of <span id="summHeapMax">-</span></div>
              <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" id="summHeapBar" role="progressbar" style="width: 0%; background-color: #00aeee;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">OS RAM</div>
            <div class="card-body text-center">
              <div class="fs-4" id="summRamUsed">-</div>
              <div class="text-muted small">of <span id="summRamTotal">-</span></div>
              <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" id="summRamBar" role="progressbar" style="width: 0%; background-color: #FFA502;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">OS Disk</div>
            <div class="card-body text-center">
              <div class="fs-4" id="summDiskUsed">-</div>
              <div class="text-muted small">of <span id="summDiskTotal">-</span></div>
              <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" id="summDiskBar" role="progressbar" style="width: 0%; background-color: #48C392;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">Read Cache</div>
            <div class="card-body text-center">
              <div class="fs-4" id="summCacheUsed">-</div>
              <div class="text-muted small">of <span id="summCacheMax">-</span></div>
              <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar" id="summCacheBar" role="progressbar" style="width: 0%; background-color: #7c3aed;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card">
            <div class="card-header">Tx Ops/Min</div>
            <div class="card-body text-center">
              <div class="fs-2" id="summOpsPerSec">-</div>
              <div class="text-muted small"><span id="summOpsTotal">-</span> total ops</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">Transaction Operations</div>
            <div class="card-body">
              <div id="serverChartCommands" style="min-height: 250px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade show" id="tab-server-sessions" role="tabpanel">
      <div class="row mb-3">
        <div class="col-12">
          <span style="font-size: 0.85rem; color: var(--text-muted);">Active authentication sessions</span>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="table-responsive">
            <table id="serverSessions" class="table table-striped table-sm" style="width: 100%"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade show" id="tab-server-events" role="tabpanel">
      <div class="row">
        <div class="col-1"><label for="serverEventsFile">File</label></div>
        <div class="col-3"><select id="serverEventsFile"></select></div>
        <div class="col-1"><label for="serverEventsType">Type</label></div>
        <div class="col-1">
          <select id="serverEventsType">
            <option value="ALL">ALL</option>
            <option value="CRITICAL">CRITICAL</option>
            <option value="WARNING">WARNING</option>
            <option value="INFO">INFO</option>
            <option value="HINT">HINT</option>
          </select>
        </div>
        <div class="col-1"><label for="serverEventsComponent">Component</label></div>
        <div class="col-2">
          <select id="serverEventsComponent">
            <option value="ALL">ALL</option>
          </select>
        </div>
        <div class="col-1"><label for="serverEventsDb">Database</label></div>
        <div class="col-2">
          <select id="serverEventsDb">
            <option value="ALL">ALL</option>
          </select>
        </div>
      </div>
      <br />
      <div class="row">
        <div class="col-12">
          <div class="table-responsive">
            <table id="serverEvents" class="table table-striped table-sm" style="width: 100%; table-layout: fixed"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade show" id="tab-metrics" role="tabpanel">
      <div style="padding: 16px; overflow-y: auto; height: 100%;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="fa fa-chart-bar"></i> Server Metrics</h5>
          <button class="btn btn-sm db-action-btn" onclick="updateServer()"><i class="fa fa-sync"></i> Refresh</button>
        </div>

        <!-- HTTP Meters -->
        <div class="card mb-3">
          <div class="card-header">HTTP Request Meters</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Endpoint</th>
                    <th class="text-end">Total Requests</th>
                    <th class="text-end">Req/Min</th>
                  </tr>
                </thead>
                <tbody id="srvMetricMetersTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Database Operations -->
        <div class="card mb-3">
          <div class="card-header">Database Operations</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="text-end">Total</th>
                    <th class="text-end">Req/Min</th>
                  </tr>
                </thead>
                <tbody id="srvMetricDbOpsTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Profiler Details -->
        <div class="card mb-3">
          <div class="card-header">Profiler Details</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="text-end">Value</th>
                  </tr>
                </thead>
                <tbody id="srvMetricProfilerTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane" id="tab-server-settings" role="tabpanel">
      <div class="row">
        <div class="col-12">
          <div class="table-responsive">
            <table id="serverSettings" class="table table-striped table-sm" style="width: 100%; table-layout: fixed"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-server-backup" role="tabpanel">
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <h5><i class="fa fa-archive"></i> Auto-Backup Configuration</h5>
            <div>
              <button class="btn btn-sm btn-success" onclick="saveBackupConfig()">
                <i class="fa fa-save"></i> Save Configuration
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="backupConfigStatus" class="row mb-3">
        <div class="col-12">
          <div class="alert alert-info" role="alert">
            <span id="backupStatusMessage">Loading backup configuration...</span>
          </div>
        </div>
      </div>

      <div id="backupConfigForm" style="display: none;">
        <div class="card mb-3">
          <div class="card-header">General Settings</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="backupEnabled" class="form-label">Auto-Backup Enabled</label>
                <select id="backupEnabled" class="form-select">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="backupDirectory" class="form-label">Backup Directory</label>
                <input type="text" class="form-control" id="backupDirectory" value="./backups">
              </div>
              <div class="col-md-4 mb-3">
                <label for="backupRunOnServer" class="form-label">Run On Server</label>
                <select id="backupRunOnServer" class="form-select">
                  <option value="$leader">Leader Only ($leader)</option>
                  <option value="*">All Servers (*)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Schedule</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label for="backupScheduleType" class="form-label">Schedule Type</label>
                <select id="backupScheduleType" class="form-select" onchange="toggleBackupScheduleFields()">
                  <option value="frequency">Frequency-based</option>
                  <option value="cron">CRON Expression</option>
                </select>
              </div>
              <div class="col-md-3 mb-3" id="backupFrequencyGroup">
                <label for="backupFrequency" class="form-label">Frequency (minutes)</label>
                <input type="number" class="form-control" id="backupFrequency" value="60" min="1">
              </div>
              <div class="col-md-3 mb-3" id="backupCronGroup" style="display: none;">
                <label for="backupCron" class="form-label">CRON Expression</label>
                <input type="text" class="form-control" id="backupCron" placeholder="0 0 2 * * ?">
                <small class="text-muted">sec min hour dom mon dow</small>
              </div>
              <div class="col-md-3 mb-3">
                <label for="backupWindowStart" class="form-label">Time Window Start</label>
                <input type="time" class="form-control" id="backupWindowStart">
              </div>
              <div class="col-md-3 mb-3">
                <label for="backupWindowEnd" class="form-label">Time Window End</label>
                <input type="time" class="form-control" id="backupWindowEnd">
                <small class="text-muted">Leave empty for any time</small>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header">Retention Policy</div>
          <div class="card-body">
            <div class="row align-items-end">
              <div class="col-md-2 mb-3">
                <label for="backupMaxFiles" class="form-label">Max Backup Files</label>
                <input type="number" class="form-control" id="backupMaxFiles" value="10" min="1">
              </div>
              <div class="col-md-2 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupUseTiered" onchange="toggleTieredRetention()">
                  <label class="form-check-label" for="backupUseTiered">Use Tiered Retention</label>
                </div>
              </div>
              <div id="tieredRetentionGroup" class="col-md-8" style="display: none;">
                <div class="row">
                  <div class="col mb-3">
                    <label for="backupHourly" class="form-label small">Hourly</label>
                    <input type="number" class="form-control form-control-sm" id="backupHourly" value="24" min="0">
                  </div>
                  <div class="col mb-3">
                    <label for="backupDaily" class="form-label small">Daily</label>
                    <input type="number" class="form-control form-control-sm" id="backupDaily" value="7" min="0">
                  </div>
                  <div class="col mb-3">
                    <label for="backupWeekly" class="form-label small">Weekly</label>
                    <input type="number" class="form-control form-control-sm" id="backupWeekly" value="4" min="0">
                  </div>
                  <div class="col mb-3">
                    <label for="backupMonthly" class="form-label small">Monthly</label>
                    <input type="number" class="form-control form-control-sm" id="backupMonthly" value="12" min="0">
                  </div>
                  <div class="col mb-3">
                    <label for="backupYearly" class="form-label small">Yearly</label>
                    <input type="number" class="form-control form-control-sm" id="backupYearly" value="3" min="0">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-server-mcp" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span style="font-size: 0.85rem; color: var(--text-muted);">MCP allows LLM clients (Claude Desktop, Cursor) to interact with ArcadeDB using natural language.</span>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="saveMCPConfig()"><i class="fa fa-save"></i> Save</button>
        </div>
      </div>

      <div id="mcpConfigForm">
        <div class="row g-3">
          <!-- Left column: Settings -->
          <div class="col-md-5">
            <div class="db-detail-section">
              <h6><i class="fa fa-cog"></i> Settings</h6>
              <div class="d-flex align-items-center mb-3">
                <label for="mcpEnabled" class="form-label mb-0 me-2" style="font-size: 0.84rem;">MCP Server</label>
                <select id="mcpEnabled" class="form-select form-select-sm" style="width: auto;">
                  <option value="true">Enabled</option>
                  <option value="false">Disabled</option>
                </select>
              </div>
              <div style="font-size: 0.78rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Permissions</div>
              <div class="d-flex flex-wrap gap-3 mb-3">
                <div class="form-check"><input class="form-check-input" type="checkbox" id="mcpAllowReads" checked disabled><label class="form-check-label" style="font-size: 0.84rem;" for="mcpAllowReads">Reads</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="mcpAllowInsert"><label class="form-check-label" style="font-size: 0.84rem;" for="mcpAllowInsert">Insert</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="mcpAllowUpdate"><label class="form-check-label" style="font-size: 0.84rem;" for="mcpAllowUpdate">Update</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="mcpAllowDelete"><label class="form-check-label" style="font-size: 0.84rem;" for="mcpAllowDelete">Delete</label></div>
                <div class="form-check"><input class="form-check-input" type="checkbox" id="mcpAllowSchemaChange"><label class="form-check-label" style="font-size: 0.84rem;" for="mcpAllowSchemaChange">Schema</label></div>
              </div>
            </div>
            <div class="db-detail-section">
              <h6><i class="fa fa-users"></i> Allowed Users</h6>
              <div class="input-group input-group-sm mb-2" style="max-width: 300px;">
                <input type="text" class="form-control" id="mcpNewUser" placeholder="Username" style="background-color: var(--bg-input); color: var(--text-primary); border-color: var(--border-ddd);">
                <button class="btn btn-outline-secondary" onclick="addMCPUser()" style="color: var(--text-secondary); border-color: var(--border-ddd);">Add</button>
              </div>
              <div id="mcpUserList"></div>
            </div>
          </div>

          <!-- Right column: Connection Info -->
          <div class="col-md-7">
            <div class="db-detail-section">
              <h6><i class="fa fa-plug"></i> Connection Info</h6>
              <div class="d-flex align-items-center mb-3">
                <label for="mcpAuthMethod" class="form-label mb-0 me-2" style="font-size: 0.84rem;">Auth Method</label>
                <select id="mcpAuthMethod" class="form-select form-select-sm" style="width: auto;" onchange="onMcpAuthMethodChange()">
                  <option value="basic">Basic Auth (current user)</option>
                  <option value="apitoken">API Token</option>
                </select>
                <select id="mcpTokenSelect" class="form-select form-select-sm ms-2" style="width: auto; display: none;" onchange="updateMCPConnectionInfo()">
                  <option value="">Select token...</option>
                </select>
              </div>
              <ul class="nav nav-tabs mb-2" role="tablist">
                <li class="nav-item"><a class="nav-link active py-1" style="font-size: 0.82rem;" data-bs-toggle="tab" href="#mcp-config-claude-desktop">Claude Desktop</a></li>
                <li class="nav-item"><a class="nav-link py-1" style="font-size: 0.82rem;" data-bs-toggle="tab" href="#mcp-config-claude-code">Claude Code / Cursor</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane fade show active" id="mcp-config-claude-desktop" role="tabpanel">
                  <p style="font-size: 0.82rem; color: var(--text-muted); margin-bottom: 6px;">Copy into <code style="background-color: var(--bg-reference); padding: 1px 5px; border-radius: 3px; font-size: 0.78rem;">claude_desktop_config.json</code> (requires <code style="background-color: var(--bg-reference); padding: 1px 5px; border-radius: 3px; font-size: 0.78rem;">npx</code> / Node.js):</p>
                  <pre class="mcp-config-code" id="mcpConfigDesktop"></pre>
                  <button class="btn btn-sm btn-primary mt-1" onclick="copyMCPConfig('mcpConfigDesktop')"><i class="fa fa-copy"></i> Copy</button>
                </div>
                <div class="tab-pane fade" id="mcp-config-claude-code" role="tabpanel">
                  <p style="font-size: 0.82rem; color: var(--text-muted); margin-bottom: 6px;">Add with <code style="background-color: var(--bg-reference); padding: 1px 5px; border-radius: 3px; font-size: 0.78rem;">claude mcp add arcadedb</code> or copy into MCP settings:</p>
                  <pre class="mcp-config-code" id="mcpConfigCode"></pre>
                  <button class="btn btn-sm btn-primary mt-1" onclick="copyMCPConfig('mcpConfigCode')"><i class="fa fa-copy"></i> Copy</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
