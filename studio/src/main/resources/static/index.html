<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />

    <!--====== Title ======-->
    <title>ArcadeDB - The Next Generation Multi-Model DBMS</title>
    <link rel="shortcut icon" href="images/arcade-favico.png" type="image/png" />

    <!-- Theme init (before CSS to prevent FOUC) -->
    <script>
    (function() {
      var p = localStorage.getItem('studio-theme') || 'light';
      var t = p === 'system' ? (matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light') : p;
      document.documentElement.setAttribute('data-theme', t);
    })();
    </script>

    <!-- SECURE NPM-MANAGED CSS DEPENDENCIES -->
    <link rel="stylesheet" href="dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="dist/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="dist/css/buttons.bootstrap5.min.css" />
    <link rel="stylesheet" href="dist/css/responsive.bootstrap5.min.css" />
    <link rel="stylesheet" href="dist/css/select.bootstrap5.min.css" />
    <link rel="stylesheet" href="dist/css/codemirror.css" />
    <link rel="stylesheet" href="dist/css/show-hint.css" />
    <link rel="stylesheet" href="dist/css/neo.css" />
    <link rel="stylesheet" href="dist/css/fontawesome.min.css" />
    <link rel="stylesheet" href="dist/css/apexcharts.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/studio.css" />

    <!-- SECURE NPM-MANAGED JAVASCRIPT DEPENDENCIES -->
    <!-- Core Libraries -->
    <script src="dist/js/jquery.min.js"></script>
    <script src="dist/js/bootstrap.bundle.min.js"></script>

    <!-- Code Editor -->
    <script src="dist/js/codemirror.js"></script>
    <script src="dist/js/cypher.js"></script>
    <script src="dist/js/javascript.js"></script>
    <script src="dist/js/sql.js"></script>
    <script src="dist/js/show-hint.js"></script>
    <script src="dist/js/sql-hint.js"></script>

    <!-- DataTables Export Dependencies -->
    <script src="dist/js/jszip.min.js"></script>
    <script src="dist/js/pdfmake.min.js"></script>
    <script src="dist/js/vfs_fonts.js"></script>

    <!-- Data Tables -->
    <script src="dist/js/dataTables.min.js"></script>
    <script src="dist/js/dataTables.bootstrap5.min.js"></script>
    <script src="dist/js/dataTables.buttons.min.js"></script>
    <script src="dist/js/buttons.bootstrap5.min.js"></script>
    <script src="dist/js/buttons.html5.min.js"></script>
    <script src="dist/js/buttons.print.min.js"></script>
    <script src="dist/js/dataTables.responsive.min.js"></script>
    <script src="dist/js/responsive.bootstrap5.min.js"></script>
    <script src="dist/js/dataTables.select.min.js"></script>
    <script src="dist/js/select.bootstrap5.min.js"></script>

    <!-- Visualization Libraries -->
    <script src="dist/js/cytoscape.min.js"></script>
    <!-- fcose layout dependencies (must load in order: layout-base -> cose-base -> fcose) -->
    <script src="dist/js/layout-base.js"></script>
    <script src="dist/js/cose-base.js"></script>
    <script src="dist/js/cytoscape-fcose.js"></script>
    <script src="dist/js/cytoscape-cxtmenu.js"></script>
    <script src="dist/js/cytoscape-graphml.js"></script>
    <script src="dist/js/cytoscape-node-html-label.min.js"></script>
    <script src="dist/js/apexcharts.min.js"></script>

    <!-- COMPATIBILITY LAYER -->
    <script>
      // Bootstrap 4 â†’ 5 Compatibility Shims
      $(document).ready(function() {
        $('[data-toggle]').each(function() {
          const toggle = $(this).attr('data-toggle');
          $(this).attr('data-bs-toggle', toggle);
        });
        $('[data-dismiss]').each(function() {
          const dismiss = $(this).attr('data-dismiss');
          $(this).attr('data-bs-dismiss', dismiss);
        });
      });

      // Notification system using Bootstrap Toasts
      var isToastReady = false;
      var notificationQueue = [];

      document.addEventListener('DOMContentLoaded', function() {
        isToastReady = true;
        processNotificationQueue();
      });

      function processNotificationQueue() {
        while (notificationQueue.length > 0 && isToastReady) {
          var n = notificationQueue.shift();
          showNotification(n.title, n.message, n.type);
        }
      }

      function showNotification(title, message, type) {
        var container = document.getElementById('toastContainer');
        if (!container) return;

        var isError = (type === 'danger' || type === 'error');
        var iconClass = isError ? 'fa-circle-exclamation' : (type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-check');
        var iconColor = isError ? '#dc3545' : (type === 'warning' ? '#ffc107' : '#28a745');

        var toastEl = document.createElement('div');
        toastEl.className = 'toast studio-toast';
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML =
          '<div class="toast-header">' +
            '<i class="fa ' + iconClass + ' me-2" style="color:' + iconColor + '"></i>' +
            '<strong class="me-auto">' + (title || '') + '</strong>' +
            '<button type="button" class="btn-close" data-bs-dismiss="toast"></button>' +
          '</div>' +
          '<div class="toast-body">' + (message || '') + '</div>';

        container.appendChild(toastEl);
        var toast = new bootstrap.Toast(toastEl, { delay: 3500 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', function() { toastEl.remove(); });
      }

      function globalNotify(title, message, type) {
        if (!isToastReady) {
          notificationQueue.push({ title: title, message: message, type: type });
          return;
        }
        showNotification(title, message, type);
      }
    </script>

    <script src="js/studio-utils.js"></script>
    <script src="js/studio-database.js"></script>
    <script src="js/studio-server.js"></script>
    <script src="js/studio-profiler.js"></script>
    <script src="js/studio-security.js"></script>
    <script src="js/studio-cluster.js"></script>
    <script src="js/studio-table.js"></script>
    <script src="js/studio-graph.js"></script>
    <script src="js/studio-graph-widget.js"></script>
    <script src="js/studio-graph-functions.js"></script>
    <script src="js/studio-record-editor.js"></script>
    <script src="js/studio-timeseries.js"></script>
    <script src="dist/js/marked.min.js"></script>
    <script src="js/studio-ai.js"></script>
  </head>
  <body>
    <div id="welcomePanel" style="display: none;"></div>

    <div id="studioPanel" class="card-hover-shadow-2x card" style="display: none">
      <div class="card-header-tab card-header">
        <div class="row">
          <div class="col-1">
            <ul class="nav nav-tabs flex-column" id="tabs" style="height: 100%">
              <li class="nav-item text-center" style="padding: 8px 6px"><img src="images/arcadedb-logo-mini.png" style="width: 80%" /></li>
              <li class="nav-item pt-3">
                <a data-bs-toggle="tab" href="#tab-query" class="vertical-tab nav-link active show" id="tab-query-sel" title="Query">
                  <center>
                    <i class="fa fa-terminal" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Query</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-database" class="vertical-tab nav-link" id="tab-database-sel" title="Database">
                  <center>
                    <i class="fa fa-database" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Database</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-timeseries" class="vertical-tab nav-link" id="tab-timeseries-sel" title="TimeSeries">
                  <center>
                    <i class="fa fa-chart-line" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">TimeSeries</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-server" class="vertical-tab nav-link" id="tab-server-sel" title="Server">
                  <center>
                    <i class="fa fa-server" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Server</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-profiler" class="vertical-tab nav-link" id="tab-profiler-sel" title="Profiler">
                  <center>
                    <i class="fa fa-tachometer-alt" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Profiler</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-security" class="vertical-tab nav-link" id="tab-security-sel" title="Security">
                  <center>
                    <i class="fa fa-shield-alt" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Security</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-cluster" class="vertical-tab nav-link" id="tab-cluster-sel" title="Cluster">
                  <center>
                    <i class="fa fa-network-wired" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Cluster</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-api" class="vertical-tab nav-link" id="tab-api-sel" title="API">
                  <center>
                    <i class="fa fa-plug" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">API</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-resources" class="vertical-tab nav-link" id="tab-resources-sel" title="Info">
                  <center>
                    <i class="fa fa-info-circle" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Info</div>
                  </center>
                </a>
              </li>
              <li class="nav-item">
                <a data-bs-toggle="tab" href="#tab-ai" class="vertical-tab nav-link" id="tab-ai-sel" title="AI">
                  <center>
                    <i class="fa fa-robot" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">AI</div>
                  </center>
                </a>
              </li>
              <!-- Spacer pushes Settings + Logout to bottom -->
              <li style="flex: 1;"></li>
              <!-- Settings -->
              <li class="nav-item" style="border-top: 1px solid var(--border-main);">
                <a data-bs-toggle="tab" href="#tab-settings" class="vertical-tab nav-link" id="tab-settings-sel" title="Settings">
                  <center>
                    <i class="fa fa-gear" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Settings</div>
                  </center>
                </a>
              </li>
              <!-- Logout (pinned bottom) -->
              <li class="nav-item">
                <a
                  href="javascript:logout()"
                  class="vertical-tab nav-link"
                  id="logout-sel"
                  title="Logout"
                >
                  <center>
                    <i class="fa fa-power-off" style="font-size: 1.5rem;"></i>
                    <div class="nav-label">Logout</div>
                  </center>
                </a>
              </li>
            </ul>
          </div>

          <div class="col-11">
            <div class="tab-content">
              ${include:query.html} ${include:database.html} ${include:timeseries.html} ${include:server.html} ${include:profiler.html} ${include:security.html} ${include:cluster.html} ${include:ai.html} ${include:api.html} ${include:resources.html} ${include:settings.html}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="popup" tabindex="-1" role="dialog" aria-labelledby="popupLabel" aria-hidden="true" style="z-index: 10000">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="popupLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div id="popupBody" class="modal-body"></div>
        </div>
      </div>
    </div>

    <!-- Global reusable modal -->
    <div class="modal fade" id="globalModal" tabindex="-1" style="z-index: 10100">
      <div class="modal-dialog" id="globalModalDialog">
        <div class="modal-content">
          <div class="modal-header">
            <span id="globalModalIcon" class="me-2"></span>
            <h5 class="modal-title" id="globalModalLabel"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="globalModalBody"></div>
          <div class="modal-footer" id="globalModalFooter"></div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 10500;"></div>

    ${include:popup-login.html}

    <script>
      var studioCurrentTab = "query";

      $(function () {
        $("#loginForm").on("keypress", function (e) {
          if (e.which == 13) {
            login();
          }
        });

        $('a[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
          var activeTab = this.id;
          if (activeTab == "tab-query-sel") {
            studioCurrentTab = "query";
            editorFocus();
          } else if (activeTab == "tab-timeseries-sel") {
            studioCurrentTab = "timeseries";
            initTimeSeries();
          } else if (activeTab == "tab-server-sel") {
            studioCurrentTab = "server";
            updateServer();
          } else if (activeTab == "tab-profiler-sel") {
            studioCurrentTab = "profiler";
            initProfiler();
          } else if (activeTab == "tab-security-sel") {
            studioCurrentTab = "security";
            initSecurity();
          } else if (activeTab == "tab-cluster-sel") {
            studioCurrentTab = "cluster";
            updateCluster();
          } else if (activeTab == "tab-database-sel") {
            studioCurrentTab = "database";
          } else if (activeTab == "tab-api-sel") {
            studioCurrentTab = "api";
          } else if (activeTab == "tab-resources-sel") {
            studioCurrentTab = "resources";
          } else if (activeTab == "tab-ai-sel") {
            studioCurrentTab = "ai";
            initAi();
          } else if (activeTab == "tab-settings-sel") {
            studioCurrentTab = "settings";
          }
        });

        // Initialize searchable database selectors
        initSearchableDbSelect("queryDbSelectContainer");
        initSearchableDbSelect("schemaDbSelectContainer");
        initSearchableDbSelect("tsDbSelectContainer");

        // Check for existing session in localStorage
        if (initSessionFromStorage()) {
          console.log("Found stored session, attempting auto-login");
          updateDatabases(function () {
            console.log("Auto-login successful, initializing query editor");
            initQuery();
          });
        } else if (globalCredentials == null) {
          showLoginPopup();
        }
      });
    </script>
  </body>
</html>
